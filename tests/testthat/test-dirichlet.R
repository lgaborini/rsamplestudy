library(rsamplestudy)
library(testthat)
context("test-dirichlet")

set.seed(123)

target <- structure(list(`x[1]` = c(0.0109400869678687, 0.0665685887825875, 0.0486625581711922), `x[2]` = c(0.198839172166766, 0.0265597753429308, 0.0968249523653577), `x[3]` = c(0.0325546613582063, 0.0389865451662945, 0.100355956690105), `x[4]` = c(0.224908393864136, 0.466846926568328, 0.374707891621962), `x[5]` = c(0.532757685643023, 0.401038164139859, 0.379448641151384)), class = "data.frame", row.names = c(NA, -3L))
test_that("rdirichlet works", {
   set.seed(123)
   expect_equal(as.data.frame(fun_rdirichlet(3, 1:5)), target)
})

target_df_pop <- structure(list(source = c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L), `x[1]` = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), `x[2]` = c(4.94222308455436e-306, 0, 1.32302127172693e-305, 0, 0, 1.71509338145137e-192, 1.36374908227718e-25, 0, 0, 4.54741297039434e-210, 0.915706980744028, 0.82308365587762, 0.701323039806438, 0.976796539116942, 0.780706584842722, 0.99999562649977, 0.999305002158546, 0.925254287089406, 0.999612315469516, 0.999186068811175, 0.0050452321594028, 0.835979351377661, 0.192007109616133, 0.0672278802993246, 0.969700380566868, 0.105772919924245, 0.0939103465266601, 0.416600986265977, 0.759047957559303, 0.0260440140711248), `x[3]` = c(3.23946975672871e-16, 2.58705512117286e-10, 0.412439715837317, 2.24475973011222e-18, 2.03576471698954e-09, 2.04179254120816e-06, 4.04402973738211e-22, 9.06389127568594e-16, 0.18207110132549, 8.07323623902245e-06, 0.032490645362728, 0.17658992213885, 0.298676960193562, 0.0232034608830466, 0.219293415157278, 4.37350022979394e-06, 0.000694987475183403, 0.000802726199760174, 0.000387257658513128, 0.000813931188825132, 0.994954767748929, 0.164020648621137, 0.807992890383855, 0.932772119128759, 0.0275019647557284, 0.894227080075754, 0.906089497114479, 0.583395810429304, 0.053102021560971, 0.626571456284551), `x[4]` = c(1, 0.999999999741294, 0.587560284162682, 1, 0.999999997964235, 0.999997958207459, 1, 0.999999999999999, 0.81792889867451, 0.999991926763761, 0.0518023738932437, 0.000326421983530773, 2.71659519960126e-19, 1.15557351253533e-14, 8.02822771638415e-29, 1.26567556274662e-18, 1.03662704688205e-08, 0.0739429867108343, 4.26871970927342e-07, 4.07766437425456e-27, 9.16679783557816e-11, 1.20201379703057e-12, 1.24491455188241e-14, 5.71916662683672e-10, 0.00279765467740341, 1.96119474836827e-17, 1.56358861289421e-07, 3.20330471868617e-06, 0.187850020879726, 0.347384529644324)), row.names = c(NA, -30L), class = "data.frame")
target_df_sources <- structure(list(source = 1:3, `theta[1]` = c(1.03898574767437e-05, 1.2895942894374e-27, 2.37196822580439e-20), `theta[2]` = c(0.0011578987549266, 0.831692937296575, 0.573053153905909), `theta[3]` = c(0.0562901851771737, 0.123582001850306, 0.323927620610022), `theta[4]` = c(0.942541526210423, 0.0447250608531192, 0.103019225484069)), row.names = c(NA, -3L ), class = "data.frame")
target_alpha <- structure(list(`alpha[1]` = 0.030640458764655, `alpha[2]` = 0.285146621991887, `alpha[3]` = 0.272556804673721, `alpha[4]` = 0.411656114569737), row.names = c(NA, -1L), class = "data.frame")

test_that("rdirichlet_population works", {
   set.seed(123)
   list_pop <- fun_rdirichlet_population(10, 3, 4)
   expect_equal(list_pop$alpha %>% as.data.frame(), target_alpha)
   expect_equal(list_pop$df_pop %>% as.data.frame(), target_df_pop)
   expect_equal(list_pop$df_sources %>% as.data.frame(), target_df_sources)
})

test_that("rdirichlet_population generates the correct names", {
   p <- 4
   name_var <- 'kk'
   name_source <- 'tau'
   name_var_target <- fun_var_names(p, name_var)
   name_source_target <- fun_var_names(p, name_source)

   list_pop <- fun_rdirichlet_population(10, 3, p, name_var = name_var, name_source = name_source)
   expect_true(all(names(list_pop$df_pop) %in% c('source', name_var_target)))
   expect_true(all(names(list_pop$df_sources) %in% c('source', name_source_target)))
})